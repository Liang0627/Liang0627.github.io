{"title":"","uid":"1cd19fc71517798e2fa5b7457d1fb06e","text":"/* * Live2D Widget * https://github.com/stevenjoezhang/live2d-widget */ function loadWidget(config) { let { waifuPath, apiPath, cdnPath } = ...","date":"2022-03-08T16:41:43.593Z","updated":"2021-11-02T17:06:22.000Z","comments":true,"path":"api/pages/live2d_widget/waifu-tips.js","covers":null,"excerpt":"","content":"/*\n * Live2D Widget\n * https://github.com/stevenjoezhang/live2d-widget\n */\n\nfunction loadWidget(config) {\n\tlet { waifuPath, apiPath, cdnPath } = config;\n\tlet useCDN = false, modelList;\n\tif (typeof cdnPath === \"string\") {\n\t\tuseCDN = true;\n\t\tif (!cdnPath.endsWith(\"/\")) cdnPath += \"/\";\n\t} else if (typeof apiPath === \"string\") {\n\t\tif (!apiPath.endsWith(\"/\")) apiPath += \"/\";\n\t} else {\n\t\tconsole.error(\"Invalid initWidget argument!\");\n\t\treturn;\n\t}\n\tlocalStorage.removeItem(\"waifu-display\");\n\tsessionStorage.removeItem(\"waifu-text\");\n\tdocument.body.insertAdjacentHTML(\"beforeend\", `<div id=\"waifu\">\n\t\t\t<div id=\"waifu-tips\"></div>\n\t\t\t<canvas id=\"live2d\" width=\"800\" height=\"800\"></canvas>\n\t\t\t<div id=\"waifu-tool\">\n\t\t\t\t<span class=\"fa fa-lg fa-comment\"></span>\n\t\t\t\t<span class=\"fa fa-lg fa-paper-plane\"></span>\n\t\t\t\t<span class=\"fa fa-lg fa-user-circle\"></span>\n\t\t\t\t<span class=\"fa fa-lg fa-street-view\"></span>\n\t\t\t\t<span class=\"fa fa-lg fa-camera-retro\"></span>\n\t\t\t\t<span class=\"fa fa-lg fa-info-circle\"></span>\n\t\t\t\t<span class=\"fa fa-lg fa-times\"></span>\n\t\t\t</div>\n\t\t</div>`);\n\t// https://stackoverflow.com/questions/24148403/trigger-css-transition-on-appended-element\n\tsetTimeout(() => {\n\t\tdocument.getElementById(\"waifu\").style.bottom = 0;\n\t}, 0);\n\n\tfunction randomSelection(obj) {\n\t\treturn Array.isArray(obj) ? obj[Math.floor(Math.random() * obj.length)] : obj;\n\t}\n\t// 检测用户活动状态，并在空闲时显示消息\n\tlet userAction = false,\n\t\tuserActionTimer,\n\t\tmessageTimer,\n\t\tmessageArray = [\"好久不见，日子过得好快呢……\", \"大坏蛋！你都多久没理人家了呀，嘤嘤嘤～\", \"嗨～快来逗我玩吧！\", \"拿小拳拳锤你胸口！\", \"记得把小家加入 Adblock 白名单哦！\"];\n\twindow.addEventListener(\"mousemove\", () => userAction = true);\n\twindow.addEventListener(\"keydown\", () => userAction = true);\n\tsetInterval(() => {\n\t\tif (userAction) {\n\t\t\tuserAction = false;\n\t\t\tclearInterval(userActionTimer);\n\t\t\tuserActionTimer = null;\n\t\t} else if (!userActionTimer) {\n\t\t\tuserActionTimer = setInterval(() => {\n\t\t\t\tshowMessage(randomSelection(messageArray), 6000, 9);\n\t\t\t}, 20000);\n\t\t}\n\t}, 1000);\n\n\t(function registerEventListener() {\n\t\tdocument.querySelector(\"#waifu-tool .fa-comment\").addEventListener(\"click\", showHitokoto);\n\t\tdocument.querySelector(\"#waifu-tool .fa-paper-plane\").addEventListener(\"click\", () => {\n\t\t\tif (window.Asteroids) {\n\t\t\t\tif (!window.ASTEROIDSPLAYERS) window.ASTEROIDSPLAYERS = [];\n\t\t\t\twindow.ASTEROIDSPLAYERS.push(new Asteroids());\n\t\t\t} else {\n\t\t\t\tconst script = document.createElement(\"script\");\n\t\t\t\tscript.src = \"https://cdn.jsdelivr.net/gh/stevenjoezhang/asteroids/asteroids.js\";\n\t\t\t\tdocument.head.appendChild(script);\n\t\t\t}\n\t\t});\n\t\tdocument.querySelector(\"#waifu-tool .fa-user-circle\").addEventListener(\"click\", loadOtherModel);\n\t\tdocument.querySelector(\"#waifu-tool .fa-street-view\").addEventListener(\"click\", loadRandModel);\n\t\tdocument.querySelector(\"#waifu-tool .fa-camera-retro\").addEventListener(\"click\", () => {\n\t\t\tshowMessage(\"照好了嘛，是不是很可爱呢？\", 6000, 9);\n\t\t\tLive2D.captureName = \"photo.png\";\n\t\t\tLive2D.captureFrame = true;\n\t\t});\n\t\tdocument.querySelector(\"#waifu-tool .fa-info-circle\").addEventListener(\"click\", () => {\n\t\t\topen(\"https://github.com/stevenjoezhang/live2d-widget\");\n\t\t});\n\t\tdocument.querySelector(\"#waifu-tool .fa-times\").addEventListener(\"click\", () => {\n\t\t\tlocalStorage.setItem(\"waifu-display\", Date.now());\n\t\t\tshowMessage(\"愿你有一天能与重要的人重逢。\", 2000, 11);\n\t\t\tdocument.getElementById(\"waifu\").style.bottom = \"-500px\";\n\t\t\tsetTimeout(() => {\n\t\t\t\tdocument.getElementById(\"waifu\").style.display = \"none\";\n\t\t\t\tdocument.getElementById(\"waifu-toggle\").classList.add(\"waifu-toggle-active\");\n\t\t\t}, 3000);\n\t\t});\n\t\tconst devtools = () => {};\n\t\tconsole.log(\"%c\", devtools);\n\t\tdevtools.toString = () => {\n\t\t\tshowMessage(\"哈哈，你打开了控制台，是想要看看我的小秘密吗？\", 6000, 9);\n\t\t};\n\t\twindow.addEventListener(\"copy\", () => {\n\t\t\tshowMessage(\"你都复制了些什么呀，转载要记得加上出处哦！\", 6000, 9);\n\t\t});\n\t\twindow.addEventListener(\"visibilitychange\", () => {\n\t\t\tif (!document.hidden) showMessage(\"哇，你终于回来了～\", 6000, 9);\n\t\t});\n\t})();\n\n\t(function welcomeMessage() {\n\t\tlet text;\n\t\tif (location.pathname === \"/\") { // 如果是主页\n\t\t\tconst now = new Date().getHours();\n\t\t\tif (now > 5 && now <= 7) text = \"早上好！一日之计在于晨，美好的一天就要开始了。\";\n\t\t\telse if (now > 7 && now <= 11) text = \"上午好！工作顺利嘛，不要久坐，多起来走动走动哦！\";\n\t\t\telse if (now > 11 && now <= 13) text = \"中午了，工作了一个上午，现在是午餐时间！\";\n\t\t\telse if (now > 13 && now <= 17) text = \"午后很容易犯困呢，今天的运动目标完成了吗？\";\n\t\t\telse if (now > 17 && now <= 19) text = \"傍晚了！窗外夕阳的景色很美丽呢，最美不过夕阳红～\";\n\t\t\telse if (now > 19 && now <= 21) text = \"晚上好，今天过得怎么样？\";\n\t\t\telse if (now > 21 && now <= 23) text = [\"已经这么晚了呀，早点休息吧，晚安～\", \"深夜时要爱护眼睛呀！\"];\n\t\t\telse text = \"你是夜猫子呀？这么晚还不睡觉，明天起的来嘛？\";\n\t\t} else if (document.referrer !== \"\") {\n\t\t\tconst referrer = new URL(document.referrer),\n\t\t\t\tdomain = referrer.hostname.split(\".\")[1];\n\t\t\tif (location.hostname === referrer.hostname) text = `欢迎阅读<span>「${document.title.split(\" - \")[0]}」</span>`;\n\t\t\telse if (domain === \"baidu\") text = `Hello！来自 百度搜索 的朋友<br>你是搜索 <span>${referrer.search.split(\"&wd=\")[1].split(\"&\")[0]}</span> 找到的我吗？`;\n\t\t\telse if (domain === \"so\") text = `Hello！来自 360搜索 的朋友<br>你是搜索 <span>${referrer.search.split(\"&q=\")[1].split(\"&\")[0]}</span> 找到的我吗？`;\n\t\t\telse if (domain === \"google\") text = `Hello！来自 谷歌搜索 的朋友<br>欢迎阅读<span>「${document.title.split(\" - \")[0]}」</span>`;\n\t\t\telse text = `Hello！来自 <span>${referrer.hostname}</span> 的朋友`;\n\t\t} else {\n\t\t\ttext = `欢迎阅读<span>「${document.title.split(\" - \")[0]}」</span>`;\n\t\t}\n\t\tshowMessage(text, 7000, 8);\n\t})();\n\n\tfunction showHitokoto() {\n\t\t// 增加 hitokoto.cn 的 API\n\t\tfetch(\"https://v1.hitokoto.cn\")\n\t\t\t.then(response => response.json())\n\t\t\t.then(result => {\n\t\t\t\tconst text = `这句一言来自 <span>「${result.from}」</span>，是 <span>${result.creator}</span> 在 hitokoto.cn 投稿的。`;\n\t\t\t\tshowMessage(result.hitokoto, 6000, 9);\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tshowMessage(text, 4000, 9);\n\t\t\t\t}, 6000);\n\t\t\t});\n\t}\n\n\tfunction showMessage(text, timeout, priority) {\n\t\tif (!text || (sessionStorage.getItem(\"waifu-text\") && sessionStorage.getItem(\"waifu-text\") > priority)) return;\n\t\tif (messageTimer) {\n\t\t\tclearTimeout(messageTimer);\n\t\t\tmessageTimer = null;\n\t\t}\n\t\ttext = randomSelection(text);\n\t\tsessionStorage.setItem(\"waifu-text\", priority);\n\t\tconst tips = document.getElementById(\"waifu-tips\");\n\t\ttips.innerHTML = text;\n\t\ttips.classList.add(\"waifu-tips-active\");\n\t\tmessageTimer = setTimeout(() => {\n\t\t\tsessionStorage.removeItem(\"waifu-text\");\n\t\t\ttips.classList.remove(\"waifu-tips-active\");\n\t\t}, timeout);\n\t}\n\n\t(function initModel() {\n\t\tlet modelId = localStorage.getItem(\"modelId\"),\n\t\t\tmodelTexturesId = localStorage.getItem(\"modelTexturesId\");\n\t\tif (modelId === null) {\n\t\t\t// 首次访问加载 指定模型 的 指定材质\n\t\t\tmodelId = 1; // 模型 ID\n\t\t\tmodelTexturesId = 53; // 材质 ID\n\t\t}\n\t\tloadModel(modelId, modelTexturesId);\n\t\tfetch(waifuPath)\n\t\t\t.then(response => response.json())\n\t\t\t.then(result => {\n\t\t\t\twindow.addEventListener(\"mouseover\", event => {\n\t\t\t\t\tfor (let { selector, text } of result.mouseover) {\n\t\t\t\t\t\tif (!event.target.matches(selector)) continue;\n\t\t\t\t\t\ttext = randomSelection(text);\n\t\t\t\t\t\ttext = text.replace(\"{text}\", event.target.innerText);\n\t\t\t\t\t\tshowMessage(text, 4000, 8);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\twindow.addEventListener(\"click\", event => {\n\t\t\t\t\tfor (let { selector, text } of result.click) {\n\t\t\t\t\t\tif (!event.target.matches(selector)) continue;\n\t\t\t\t\t\ttext = randomSelection(text);\n\t\t\t\t\t\ttext = text.replace(\"{text}\", event.target.innerText);\n\t\t\t\t\t\tshowMessage(text, 4000, 8);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tresult.seasons.forEach(({ date, text }) => {\n\t\t\t\t\tconst now = new Date(),\n\t\t\t\t\t\tafter = date.split(\"-\")[0],\n\t\t\t\t\t\tbefore = date.split(\"-\")[1] || after;\n\t\t\t\t\tif ((after.split(\"/\")[0] <= now.getMonth() + 1 && now.getMonth() + 1 <= before.split(\"/\")[0]) && (after.split(\"/\")[1] <= now.getDate() && now.getDate() <= before.split(\"/\")[1])) {\n\t\t\t\t\t\ttext = randomSelection(text);\n\t\t\t\t\t\ttext = text.replace(\"{year}\", now.getFullYear());\n\t\t\t\t\t\t//showMessage(text, 7000, true);\n\t\t\t\t\t\tmessageArray.push(text);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t})();\n\n\tasync function loadModelList() {\n\t\tconst response = await fetch(`${cdnPath}model_list.json`);\n\t\tmodelList = await response.json();\n\t}\n\n\tasync function loadModel(modelId, modelTexturesId, message) {\n\t\tlocalStorage.setItem(\"modelId\", modelId);\n\t\tlocalStorage.setItem(\"modelTexturesId\", modelTexturesId);\n\t\tshowMessage(message, 4000, 10);\n\t\tif (useCDN) {\n\t\t\tif (!modelList) await loadModelList();\n\t\t\tconst target = randomSelection(modelList.models[modelId]);\n\t\t\tloadlive2d(\"live2d\", `${cdnPath}model/${target}/index.json`);\n\t\t} else {\n\t\t\tloadlive2d(\"live2d\", `${apiPath}get/?id=${modelId}-${modelTexturesId}`);\n\t\t\tconsole.log(`Live2D 模型 ${modelId}-${modelTexturesId} 加载完成`);\n\t\t}\n\t}\n\n\tasync function loadRandModel() {\n\t\tconst modelId = localStorage.getItem(\"modelId\"),\n\t\t\tmodelTexturesId = localStorage.getItem(\"modelTexturesId\");\n\t\tif (useCDN) {\n\t\t\tif (!modelList) await loadModelList();\n\t\t\tconst target = randomSelection(modelList.models[modelId]);\n\t\t\tloadlive2d(\"live2d\", `${cdnPath}model/${target}/index.json`);\n\t\t\tshowMessage(\"我的新衣服好看嘛？\", 4000, 10);\n\t\t} else {\n\t\t\t// 可选 \"rand\"(随机), \"switch\"(顺序)\n\t\t\tfetch(`${apiPath}rand_textures/?id=${modelId}-${modelTexturesId}`)\n\t\t\t\t.then(response => response.json())\n\t\t\t\t.then(result => {\n\t\t\t\t\tif (result.textures.id === 1 && (modelTexturesId === 1 || modelTexturesId === 0)) showMessage(\"我还没有其他衣服呢！\", 4000, 10);\n\t\t\t\t\telse loadModel(modelId, result.textures.id, \"我的新衣服好看嘛？\");\n\t\t\t\t});\n\t\t}\n\t}\n\n\tasync function loadOtherModel() {\n\t\tlet modelId = localStorage.getItem(\"modelId\");\n\t\tif (useCDN) {\n\t\t\tif (!modelList) await loadModelList();\n\t\t\tconst index = (++modelId >= modelList.models.length) ? 0 : modelId;\n\t\t\tloadModel(index, 0, modelList.messages[index]);\n\t\t} else {\n\t\t\tfetch(`${apiPath}switch/?id=${modelId}`)\n\t\t\t\t.then(response => response.json())\n\t\t\t\t.then(result => {\n\t\t\t\t\tloadModel(result.model.id, 0, result.model.message);\n\t\t\t\t});\n\t\t}\n\t}\n}\n\nfunction initWidget(config, apiPath) {\n\tif (typeof config === \"string\") {\n\t\tconfig = {\n\t\t\twaifuPath: config,\n\t\t\tapiPath\n\t\t};\n\t}\n\tdocument.body.insertAdjacentHTML(\"beforeend\", `<div id=\"waifu-toggle\">\n\t\t\t<span>看板娘</span>\n\t\t</div>`);\n\tconst toggle = document.getElementById(\"waifu-toggle\");\n\ttoggle.addEventListener(\"click\", () => {\n\t\ttoggle.classList.remove(\"waifu-toggle-active\");\n\t\tif (toggle.getAttribute(\"first-time\")) {\n\t\t\tloadWidget(config);\n\t\t\ttoggle.removeAttribute(\"first-time\");\n\t\t} else {\n\t\t\tlocalStorage.removeItem(\"waifu-display\");\n\t\t\tdocument.getElementById(\"waifu\").style.display = \"\";\n\t\t\tsetTimeout(() => {\n\t\t\t\tdocument.getElementById(\"waifu\").style.bottom = 0;\n\t\t\t}, 0);\n\t\t}\n\t});\n\tif (localStorage.getItem(\"waifu-display\") && Date.now() - localStorage.getItem(\"waifu-display\") <= 86400000) {\n\t\ttoggle.setAttribute(\"first-time\", true);\n\t\tsetTimeout(() => {\n\t\t\ttoggle.classList.add(\"waifu-toggle-active\");\n\t\t}, 0);\n\t} else {\n\t\tloadWidget(config);\n\t}\n}\n","count_time":{"symbolsCount":"7.9k","symbolsTime":"7 mins."},"toc":""}